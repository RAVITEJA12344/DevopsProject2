pipeline {
    agent any
    
 /*   parameters {
        string(name: 'ECR_REPO_NAME', defaultValue: 'amazon-prime-video', description: 'ECR repository name')
        string(name: 'AWS_ACCOUNT_ID', defaultValue: '667467573891', description: 'Enter AWS Account ID') // Added missing quote
    } */
	  parameters {
        string(name: 'ECR_REPO_NAME', defaultValue: 'amazon-prime-video', description: 'ECR repository name')
        string(name: 'AWS_ACCOUNT_ID', defaultValue: '667467573891', description: 'AWS Account ID')
    }

    
    tools {
        jdk 'jdk17'
        nodejs 'node16'
    }
    
    environment {
        SCANNER_HOME = tool 'sonar-scanner'
    }
    
    stages {
        stage('1. Git Checkout') {
            steps {
                git branch: 'main', url: 'https://github.com/RAVITEJA12344/DevopsProject2.git'
            }
        }
        
        stage('2. SonarQube Analysis') {
            steps {
                withSonarQubeEnv ('SonarQube') {
                    sh """
                    $SCANNER_HOME/bin/sonar-scanner \
                    -Dsonar.projectName=amazon-prime \
                    -Dsonar.projectKey=amazon-prime
                    """
                }
            }
        }
        
        stage('3. Quality Gate') {
            steps {
                waitForQualityGate abortPipeline: false, 
                credentialsId: 'sonar-token'
            }
        }
        
        stage('4. Install npm') {
            steps {
                sh "npm install"
            }
        }
        
        stage('5. Trivy Scan') {
            steps {
                sh "trivy fs . > trivy.txt"
            }
        }
        
        stage('6. Build Docker Image') {
            steps {
                sh "docker build -t ${params.ECR_REPO_NAME} ."
            }
        }
        
    /*    stage('7. Create ECR repo') {
            steps {
                withCredentials([string(credentialsId: 'access-key', variable: 'AWS_ACCESS_KEY'), 
                                 string(credentialsId: 'secret-key', variable: 'AWS_SECRET_KEY')]) {
                    sh """
                    aws configure set aws_access_key_id $AWS_ACCESS_KEY
                    aws configure set aws_secret_access_key $AWS_SECRET_KEY
                    aws ecr describe-repositories --repository-names ${params.ECR_REPO_NAME} --region us-east-1 || \
                    aws ecr create-repository --repository-name ${params.ECR_REPO_NAME} --region us-east-1
                    """
                }
            }
        } */  
		stage('7. Create ECR repo') {
		    steps {
		        withCredentials([[
		            $class: 'AmazonWebServicesCredentialsBinding',
		            credentialsId: 'aws-creds'
		        ]]) {
		            sh '''
		              aws ecr describe-repositories \
		                --repository-names ${ECR_REPO_NAME} \
		                --region us-east-1 \
		              || aws ecr create-repository \
		                --repository-name ${ECR_REPO_NAME} \
		                --region us-east-1
		            '''
		        }
		    }
		}

      /*  stage('8. Login to ECR & tag image') {
            steps {
                withCredentials([string(credentialsId: 'access-key', variable: 'AWS_ACCESS_KEY'), 
                                 string(credentialsId: 'secret-key', variable: 'AWS_SECRET_KEY')]) {
                    sh """
                    aws ecr get-login-password --region us-east-1 | docker login --username AWS --password-stdin ${params.AWS_ACCOUNT_ID}.dkr.ecr.us-east-1.amazonaws.com
                    docker tag ${params.ECR_REPO_NAME} ${params.AWS_ACCOUNT_ID}.dkr.ecr.us-east-1.amazonaws.com/${params.ECR_REPO_NAME}:${BUILD_NUMBER}
                    docker tag ${params.ECR_REPO_NAME} ${params.AWS_ACCOUNT_ID}.dkr.ecr.us-east-1.amazonaws.com/${params.ECR_REPO_NAME}:latest
                    """
                }
            }
        } */
		stage('8. Login to ECR & Tag Image') {
		    steps {
		        withCredentials([[
		            $class: 'AmazonWebServicesCredentialsBinding',
		            credentialsId: 'aws-creds'
		        ]]) {
		            sh '''
		              aws ecr get-login-password --region us-east-1 \
		              | docker login --username AWS --password-stdin \
		                ${AWS_ACCOUNT_ID}.dkr.ecr.us-east-1.amazonaws.com
		
		              docker tag ${ECR_REPO_NAME}:latest \
		                ${AWS_ACCOUNT_ID}.dkr.ecr.us-east-1.amazonaws.com/${ECR_REPO_NAME}:${BUILD_NUMBER}
		
		              docker tag ${ECR_REPO_NAME}:latest \
		                ${AWS_ACCOUNT_ID}.dkr.ecr.us-east-1.amazonaws.com/${ECR_REPO_NAME}:latest
		            '''
		        }
		    }
		}
    /*    stage('9. Push image to ECR') {
            steps {
                withCredentials([string(credentialsId: 'access-key', variable: 'AWS_ACCESS_KEY'), 
                                 string(credentialsId: 'secret-key', variable: 'AWS_SECRET_KEY')]) {
                    sh """
                    docker push ${params.AWS_ACCOUNT_ID}.dkr.ecr.us-east-1.amazonaws.com/${params.ECR_REPO_NAME}:${BUILD_NUMBER}
                    docker push ${params.AWS_ACCOUNT_ID}.dkr.ecr.us-east-1.amazonaws.com/${params.ECR_REPO_NAME}:latest
                    """
                }
            }
        } */
        stage('9. Push Image to ECR') {
		    steps {
		        sh '''
		          docker push ${AWS_ACCOUNT_ID}.dkr.ecr.us-east-1.amazonaws.com/${ECR_REPO_NAME}:${BUILD_NUMBER}
		          docker push ${AWS_ACCOUNT_ID}.dkr.ecr.us-east-1.amazonaws.com/${ECR_REPO_NAME}:latest
		        '''
		    }
		}
 /*    stage('10. Cleanup Images') {
            steps {
                sh """
	              docker rmi ${params.AWS_ACCOUNT_ID}.dkr.ecr.us-east-1.amazonaws.com/${params.ECR_REPO_NAME}:${BUILD_NUMBER}
	              docker rmi ${params.AWS_ACCOUNT_ID}.dkr.ecr.us-east-1.amazonaws.com/${params.ECR_REPO_NAME}:latest
				  docker images
                """
            }
        } */
		stage('10. Cleanup Images') {
		    steps {
		        sh '''
		          docker rmi ${AWS_ACCOUNT_ID}.dkr.ecr.us-east-1.amazonaws.com/${ECR_REPO_NAME}:${BUILD_NUMBER} || true
		          docker rmi ${AWS_ACCOUNT_ID}.dkr.ecr.us-east-1.amazonaws.com/${ECR_REPO_NAME}:latest || true
		          docker images
		        '''
		    }
		}
}
			 post {
		    success {
		        emailext(
		            to: 'ravitejaravirala2@gmail.com',
		            subject: "‚úÖ SUCCESS: ${JOB_NAME} #${BUILD_NUMBER}",
		            mimeType: 'text/html',
		            body: """
		                <h2>Build Successful üéâ</h2>
		                <p><b>Job:</b> ${JOB_NAME}</p>
		                <p><b>Build:</b> ${BUILD_NUMBER}</p>
		                <p><b>Status:</b> SUCCESS</p>
		                <p><a href="${BUILD_URL}">View Build</a></p>
		            """
		        )
		
		        slackSend(
		            webhookUrl: credentials('slack-webhook'),
		            color: 'good',
		            message: """
		‚úÖ *SUCCESS*
		Job: ${JOB_NAME}
		Build: #${BUILD_NUMBER}
		<${BUILD_URL}|View Build>
		"""
		        )
		    }
		
		    failure {
		        emailext(
		            to: 'ravitejaravirala2@gmail.com',
		            subject: "‚ùå FAILED: ${JOB_NAME} #${BUILD_NUMBER}",
		            mimeType: 'text/html',
		            body: """
		                <h2>Build Failed ‚ùå</h2>
		                <p><b>Job:</b> ${JOB_NAME}</p>
		                <p><b>Build:</b> ${BUILD_NUMBER}</p>
		                <p><a href="${BUILD_URL}">Check Logs</a></p>
		            """
		        )
		
		        slackSend(
		            webhookUrl: credentials('slack-webhook'),
		            color: 'danger',
		            message: """
		‚ùå *FAILED*
		Job: ${JOB_NAME}
		Build: #${BUILD_NUMBER}
		<${BUILD_URL}|Check Logs>
		"""
		        )
		    }
		}
}
